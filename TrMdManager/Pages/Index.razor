@page "/index.html"
@using TrMdManager.Components
@using Microsoft.JSInterop
@inject NavigationManager NavigationManager

<div class="main-container">
    <div class="app-header">
        <div class="header-content">
            <img src="icon-48.png" alt="Logo" class="app-logo" />
            <h3 class="app-title">Techie Mark Down Manager</h3>
            <span class="app-subtitle">Markdown Viewer & Editor</span>
        </div>
    </div>
    <MarkdownEditor @ref="markdownEditor" InitialContent="@InitialMarkdown" StartInPreview="@_startInPreview" />
</div>

<style>
    .main-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .app-header {
        background: rgba(255,255,255,0.98);
        padding: 15px 30px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-bottom: 2px solid transparent;
        background-clip: padding-box;
    }
    
    .header-content {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .app-logo {
        width: 40px;
        height: 40px;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    .app-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .app-subtitle {
        color: #718096;
        font-size: 0.9rem;
        margin-left: auto;
        font-weight: 500;
        padding: 4px 12px;
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-radius: 20px;
    }
</style>


@code {
    private string InitialMarkdown = @"# Welcome to Techie Mark Down Manager

This is a **Markdown** viewer and editor browser extension built with Blazor WebAssembly.

## Features

- Live preview of Markdown content
- Split view for editing and preview
- Synchronized scrolling in split view
- Support for tables, task lists, and more
- Copy to clipboard functionality

## Example Content

Here's a sample task list:
- [x] Create Blazor extension
- [x] Add Markdown support
- [x] Add synchronized scrolling
- [ ] Test the extension

### Tables

| Feature | Status | Description |
|---------|--------|-------------|
| Editor | ✅ | Full-featured markdown editor |
| Preview | ✅ | Real-time preview rendering |
| Split View | ✅ | Side-by-side editing |
| Sync Scroll | ✅ | Synchronized scrolling |

### Code Blocks

```csharp
public class MarkdownService : IMarkdownService
{
    public string ConvertToHtml(string markdown)
    {
        return Markdown.ToHtml(markdown);
    }
}
```

### Lists

1. First item
2. Second item
   - Nested item
   - Another nested item
3. Third item

### Blockquotes

> This is a blockquote
> It can span multiple lines
> > And can be nested

### Long Content for Testing Scroll

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.

Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.

Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

### More Content

Add more content here to test scrolling functionality...

Lorem ipsum dolor sit amet, consectetur adipiscing elit.

Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.

Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.

### End of Document

Enjoy writing in Markdown with synchronized scrolling!";

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
    private MarkdownEditor? markdownEditor;
    private bool _startInPreview = false;

    protected override void OnInitialized()
    {
        // Check URL parameters for preview mode synchronously
        // This ensures the flag is set before the component renders
        var uri = NavigationManager?.Uri ?? "";
        if (uri.Contains("preview=true"))
        {
            _startInPreview = true;
            Console.WriteLine("Starting in preview mode from URL parameter");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Check if we have content from the background worker
                var hasContent = await JSRuntime.InvokeAsync<bool>("ExtensionHelper.hasContent");
                if (hasContent)
                {
                    // Get content from extension helper
                    var markdownContent = await JSRuntime.InvokeAsync<string>("ExtensionHelper.getMarkdownContent");
                    
                    if (!string.IsNullOrEmpty(markdownContent))
                    {
                        Console.WriteLine($"Loaded markdown content: {markdownContent.Substring(0, Math.Min(100, markdownContent.Length))}...");
                        InitialMarkdown = markdownContent;
                        if (markdownEditor != null)
                        {
                            markdownEditor.SetContent(markdownContent);
                        }
                        StateHasChanged();
                    }
                    else
                    {
                        Console.WriteLine("No markdown content found, using default");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading content: {ex.Message}");
            }
        }
    }
}
